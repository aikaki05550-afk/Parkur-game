<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>3D Parkour: Music & Keyboard Edition</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; }
        #menu, #shopMenu, #bookUI, #tutorialUI {
            position: absolute; inset: 0; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: radial-gradient(circle, #2c3e50, #000); color: white; z-index: 100;
        }
        #ui {
            position: absolute; top: 20px; left: 20px; color: white;
            font-size: 24px; display: none; text-shadow: 2px 2px #000; font-weight: bold;
        }
        #camStatus {
            position: absolute; top: 60px; left: 20px; color: #ffeb3b; font-size: 18px; display: none;
        }
        .info { position: absolute; bottom: 20px; left: 20px; color: white; font-size: 14px; opacity: 0.8; pointer-events: none; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px; }
        .box { background: rgba(0,0,0,0.8); padding: 30px; border-radius: 20px; text-align: center; border: 2px solid #f1c40f; min-width: 320px; }
        button {
            padding: 10px 30px; font-size: 18px; cursor: pointer; margin: 10px;
            background: #27ae60; border: none; color: white; border-radius: 10px;
            transition: 0.3s; box-shadow: 0 4px 0 #1e8449;
        }
        button:hover { background: #2ecc71; transform: translateY(-2px); }
        .buy-btn { background: #f39c12; box-shadow: 0 4px 0 #d35400; }
        select { padding: 10px; margin: 5px; width: 100%; border-radius: 5px; background: #333; color: white; border: 1px solid #555; }
        #bookUI { display: none; background: rgba(0,0,0,0.95); }
        #bookImg { width: 500px; height: 350px; object-fit: cover; border: 8px solid #fff; }
        
        #openBookBtn { position: absolute; top: 20px; right: 20px; display: none; background: #9b59b6; }
        #openTutorialBtn { position: absolute; top: 80px; right: 20px; display: none; background: #3498db; font-size: 14px; padding: 10px; box-shadow: 0 4px 0 #2980b9; }

        #tutorialUI { display: none; background: rgba(0,0,0,0.8); }
        .tut-page { background: #fdf6e3; color: #2c3e50; padding: 30px; border-radius: 10px; width: 350px; text-align: left; box-shadow: 0 0 20px rgba(0,0,0,0.5); border-left: 10px solid #d35400; }
        .warning-text { color: red; font-weight: bold; font-size: 12px; margin-bottom: 10px; text-transform: uppercase; }
        .tut-page h2 { margin-top: 0; color: #d35400; border-bottom: 2px solid #eee; }
        .tut-page b { color: #27ae60; }
    </style>
</head>
<body>

<audio id="bgMusic" loop>
    <source id="musicSource" src="" type="audio/mpeg">
</audio>

<div id="tutorialUI">
    <div class="tut-page">
        <div class="warning-text">Attention: This guide is in English!</div>
        <h2>How to Play</h2>
        <p>1. <b>WASD</b> to move your character.</p>
        <p>2. <b>SPACE</b> to jump over blocks.</p>
        <p>3. <b>SHIFT</b> to run faster (Sprint).</p>
        <p>4. <b>MOUSE</b> or <b>ARROWS</b> to look around.</p>
        <p>5. Press <b>B</b> to lock cursor for better control.</p>
        <hr>
        <p><i>Tip: You can customize Hair Style and Music in the Main Menu!</i></p>
        <button onclick="closeTutorial()" style="width: 100%; margin: 10px 0 0 0;">START GAME</button>
    </div>
    <p style="margin-top: 10px; font-size: 14px;">(Training Manual)</p>
</div>

<div id="menu">
    <div class="box">
        <h1>PARKOUR ULTRA</h1>
        <p>Coins: <span id="coinCount">0</span> üí∞</p>
        <label>Hair Style:</label>
        <select id="gender">
            <option value="girl">üëß Long Ponytail</option>
            <option value="boy">üë¶ Short Spiky</option>
        </select>
        <label>Music (Minecraft Style):</label>
        <select id="musicSelect" onchange="changeMusic()">
            <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3">üéπ Calm Piano</option>
            <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3">üåô Ambient Night</option>
            <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3">üçÉ Peaceful World</option>
            <option value="off">üîá Music: OFF</option>
        </select>
        <button id="startBtn">PLAY (START)</button>
        <button class="buy-btn" onclick="toggleShop(true)">SHOP</button>
    </div>
</div>

<div id="shopMenu" style="display:none">
    <div class="box">
        <h2>MAGIC SHOP</h2>
        <p>Balance: <span class="coins">0</span> üí∞</p>
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 10px;">
            <p>üìñ Magic Photo Book</p>
            <button id="buyBookBtn" class="buy-btn" onclick="buyBook()">BUY FOR 500</button>
        </div>
        <button onclick="toggleShop(false)">BACK</button>
    </div>
</div>

<div id="bookUI">
    <h2 id="pageTitle">Page 1 / 10</h2>
    <img id="bookImg" src="" alt="Photo">
    <div>
        <button onclick="changePage(-1)">PREVIOUS</button>
        <button onclick="changePage(1)">NEXT</button>
        <button style="background:#e74c3c" onclick="toggleBook(false)">CLOSE</button>
    </div>
</div>

<div id="ui">LEVEL: <span id="lvl">1</span> | COINS: <span class="coins">0</span></div>
<div id="camStatus">Camera: 3rd Person</div>
<button id="openBookBtn" onclick="toggleBook(true)">üìñ OPEN BOOK</button>
<button id="openTutorialBtn" onclick="showTutorial()">üìñ TUTORIAL</button>

<div class="info">
    <b>M</b>: Menu | <b>B</b>: Lock Cursor | <b>WASD</b>: Move | <b>SPACE</b>: Jump | <b>C</b>: Camera<br>
    <b>ARROWS</b>: Look Around (Keyboard Mode)
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.155.0/three.min.js"></script>

<script>
let scene, camera, renderer, player, headAnchor, sun, sunSphere;
let keys = {};
let platforms = [];
let currentLevel = 1, coins = 0, hasBook = false, currentPage = 0;
let velocity = new THREE.Vector3(), yaw = 0, pitch = 0;
let camMode = 0; 
let snowParticles;

const audio = document.getElementById('bgMusic');
const musicSelect = document.getElementById('musicSelect');

function showTutorial() { document.getElementById('tutorialUI').style.display = 'flex'; document.exitPointerLock(); }
function closeTutorial() { document.getElementById('tutorialUI').style.display = 'none'; }

function changeMusic() {
    const val = musicSelect.value;
    if (val === 'off') { audio.pause(); } 
    else { document.getElementById('musicSource').src = val; audio.load(); audio.play().catch(() => {}); }
}

function updateCoins() {
    document.querySelectorAll('.coins').forEach(el => el.innerText = coins);
    document.getElementById('coinCount').innerText = coins;
}

function toggleShop(show) {
    document.getElementById('shopMenu').style.display = show ? 'flex' : 'none';
    document.getElementById('menu').style.display = show ? 'none' : 'flex';
}

function buyBook() {
    if (coins >= 500) {
        coins -= 500; hasBook = true; updateCoins();
        document.getElementById('buyBookBtn').innerText = "OWNED";
        document.getElementById('buyBookBtn').disabled = true;
        document.getElementById('openBookBtn').style.display = 'block';
    } else { alert("Not enough coins!"); }
}

function toggleBook(show) {
    document.getElementById('bookUI').style.display = show ? 'flex' : 'none';
    if(show) { currentPage = 0; updateBookPage(); document.exitPointerLock(); }
}

function changePage(dir) { currentPage = (currentPage + dir + 10) % 10; updateBookPage(); }
function updateBookPage() {
    document.getElementById('bookImg').src = `https://picsum.photos/id/${[10,13,16,24,28,29,34,42,48,54][currentPage]}/1000/700`;
    document.getElementById('pageTitle').innerText = `Photo ${currentPage + 1} / 10`;
}

document.getElementById('startBtn').onclick = () => {
    document.getElementById('menu').style.display = 'none';
    document.getElementById('ui').style.display = 'block';
    document.getElementById('camStatus').style.display = 'block';
    document.getElementById('openTutorialBtn').style.display = 'block';
    changeMusic(); 
    if(!scene) init();
    showTutorial();
};

function createModel() {
    const group = new THREE.Group();
    const gender = document.getElementById('gender').value;
    const clothesMat = new THREE.MeshStandardMaterial({ color: 0x3498db, metalness: 0.2, roughness: 0.5 });
    const body = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.8, 0.3), clothesMat);
    body.position.y = 0.45; body.castShadow = true; group.add(body);
    headAnchor = new THREE.Group();
    const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), new THREE.MeshStandardMaterial({color: 0xffdbac}));
    head.castShadow = true; headAnchor.add(head);
    const hairMat = new THREE.MeshStandardMaterial({ color: 0x4b3020 });
    const hair = new THREE.Mesh(new THREE.BoxGeometry(0.45, 0.15, 0.45), hairMat);
    hair.position.y = 0.18; headAnchor.add(hair);
    if(gender === 'girl') {
        const pony = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.5, 0.15), hairMat);
        pony.position.set(0, -0.1, -0.25); headAnchor.add(pony);
    }
    headAnchor.position.y = 1.0; group.add(headAnchor);
    return group;
}

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb);
    scene.fog = new THREE.Fog(0x87ceeb, 10, 100);
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);
    scene.add(new THREE.AmbientLight(0xffffff, 0.5));
    sunSphere = new THREE.Mesh(new THREE.SphereGeometry(4, 32, 32), new THREE.MeshBasicMaterial({ color: 0xfff3d0 }));
    sunSphere.position.set(40, 60, -50);
    scene.add(sunSphere);
    sun = new THREE.DirectionalLight(0xffffff, 1.3);
    sun.position.copy(sunSphere.position);
    sun.castShadow = true;
    scene.add(sun);

    // –°–Ω–µ–≥
    const snowGeo = new THREE.BufferGeometry();
    const snowCount = 1000;
    const snowPos = new Float32Array(snowCount * 3);
    for(let i=0; i<snowCount*3; i++) snowPos[i] = (Math.random()-0.5)*50;
    snowGeo.setAttribute('position', new THREE.BufferAttribute(snowPos, 3));
    snowParticles = new THREE.Points(snowGeo, new THREE.PointsMaterial({color: 0xffffff, size: 0.1}));
    scene.add(snowParticles);

    player = createModel();
    scene.add(player);
    player.position.set(0, 5, 0);

    buildLevel();

    window.onkeydown = (e) => {
        keys[e.code] = true;
        if(e.code === 'KeyM') { document.getElementById('menu').style.display = 'flex'; document.exitPointerLock(); }
        if(e.code === 'KeyB') document.body.requestPointerLock();
        if(e.code === 'KeyC') {
            camMode = (camMode + 1) % 3;
            document.getElementById('camStatus').innerText = "Camera: " + ["3rd Person", "1st Person", "Front View"][camMode];
        }
    };
    window.onkeyup = (e) => keys[e.code] = false;
    document.onmousemove = (e) => {
        if (document.pointerLockElement) {
            yaw -= e.movementX * 0.003;
            pitch = Math.max(-1.5, Math.min(1.5, pitch - e.movementY * 0.003));
        }
    };
    animate();
}

function buildLevel() {
    platforms.forEach(p => scene.remove(p));
    platforms = [];
    document.getElementById('lvl').innerText = currentLevel;

    // –ë–∏–æ–º—ã
    let bgColor = 0x87ceeb;
    let platColor = 0xffffff;
    let groundColor = 0x27ae60;
    snowParticles.visible = false;

    if (currentLevel >= 6 && currentLevel <= 10) { // –°–Ω–µ–∂–Ω—ã–π
        bgColor = 0xbdc3c7;
        platColor = 0xecf0f1;
        groundColor = 0xffffff;
        snowParticles.visible = true;
    } else if (currentLevel > 10) { // –†–∞–¥—É–∂–Ω—ã–π
        bgColor = 0xffd1dc;
        groundColor = 0xa29bfe;
    }

    scene.background.set(bgColor);
    scene.fog.color.set(bgColor);

    // –û–±–ª–µ–≥—á–µ–Ω–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –¥–æ 5 —É—Ä–æ–≤–Ω—è
    let gap = currentLevel <= 5 ? 5 : 7;
    let size = currentLevel <= 5 ? 4 : 3;

    addPlatform(0, -0.5, 0, 10, 1, 10, groundColor, currentLevel <= 5); 
    for(let i=1; i<=12; i++) {
        const finish = i === 12;
        let c = finish ? 0xf1c40f : (currentLevel > 10 ? Math.random() * 0xffffff : platColor);
        addPlatform((Math.random()-0.5)*15, i*1.2, -i*gap, size, 0.5, size, c, !finish && currentLevel <= 5);
    }
}

function addPlatform(x,y,z,w,h,d,color, hasGrass) {
    const mesh = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), new THREE.MeshStandardMaterial({ color, roughness: 0.6 }));
    mesh.position.set(x,y,z);
    mesh.receiveShadow = true; mesh.castShadow = true;
    scene.add(mesh);
    platforms.push(mesh);
    if(hasGrass) {
        const gMat = new THREE.MeshStandardMaterial({ color: 0x2ecc71 });
        for(let g=0; g<15; g++) {
            const grass = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.4, 0.1), gMat);
            grass.position.set((Math.random()-0.5)*w, h/2+0.2, (Math.random()-0.5)*d);
            mesh.add(grass);
        }
    }
}

function animate() {
    requestAnimationFrame(animate);
    if(keys['ArrowLeft']) yaw += 0.04;
    if(keys['ArrowRight']) yaw -= 0.04;
    if(keys['ArrowUp']) pitch = Math.min(1.5, pitch + 0.04);
    if(keys['ArrowDown']) pitch = Math.max(-1.5, pitch - 0.04);

    const speed = keys['ShiftLeft'] ? 0.25 : 0.15;
    const moveDir = new THREE.Vector3();
    if(keys['KeyW']) moveDir.z -= 1;
    if(keys['KeyS']) moveDir.z += 1;
    if(keys['KeyA']) moveDir.x -= 1;
    if(keys['KeyD']) moveDir.x += 1;
    moveDir.normalize().multiplyScalar(speed).applyAxisAngle(new THREE.Vector3(0,1,0), yaw);
    
    player.position.add(moveDir);
    player.rotation.y = yaw;
    headAnchor.rotation.x = pitch;

    velocity.y -= 0.018;
    player.position.y += velocity.y;

    // –ê–Ω–∏–º–∞—Ü–∏—è —Å–Ω–µ–≥–∞
    if(snowParticles.visible) {
        snowParticles.position.set(player.position.x, player.position.y + 10, player.position.z);
        const positions = snowParticles.geometry.attributes.position.array;
        for(let i=1; i<positions.length; i+=3) {
            positions[i] -= 0.1;
            if(positions[i] < -20) positions[i] = 20;
        }
        snowParticles.geometry.attributes.position.needsUpdate = true;
    }

    let onGround = false;
    platforms.forEach(p => {
        let dx = Math.abs(player.position.x - p.position.x);
        let dz = Math.abs(player.position.z - p.position.z);
        if(dx < p.geometry.parameters.width/2 + 0.3 && dz < p.geometry.parameters.depth/2 + 0.3) {
            if(player.position.y > p.position.y && player.position.y < p.position.y + 1.2 && velocity.y <= 0) {
                player.position.y = p.position.y + 1;
                velocity.y = 0;
                onGround = true;
                if(p.material.color.getHex() === 0xf1c40f) {
                    coins += 100; currentLevel++; updateCoins();
                    player.position.set(0,5,0); buildLevel();
                }
            }
        }
    });

    if(onGround && keys['Space']) velocity.y = 0.38;
    if(player.position.y < -20) { player.position.set(0,5,0); velocity.y = 0; }

    if (camMode === 1) {
        player.visible = false;
        camera.position.copy(player.position).add(new THREE.Vector3(0, 1.2, 0));
        camera.rotation.set(pitch, yaw, 0, 'YXZ');
    } else {
        player.visible = true;
        let dist = camMode === 2 ? -5 : 6;
        let offset = new THREE.Vector3(0, 2, dist).applyQuaternion(player.quaternion);
        camera.position.copy(player.position).add(offset);
        camera.lookAt(player.position.clone().add(new THREE.Vector3(0, 1, 0)));
    }
    renderer.render(scene, camera);
}
</script>
</body>
</html>